{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
  <div class="card shadow">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0">
        {% if form.instance.pk %}
          Editar Labor
        {% else %}
          Crear Labor
        {% endif %}
      </h4>
    </div>
    <div class="card-body">
      <form method="POST" id="laborForm">
        {% csrf_token %}

        <!-- Campo: Finca -->
        <div class="mb-3">
          <label for="id_finca" class="form-label">Finca</label>
          {{ form.finca }}
        </div>

        <!-- Campo: Trabajador -->
        <div class="mb-3">
          <label for="id_trabajador" class="form-label">Trabajador</label>
          {{ form.trabajador }}
        </div>

        <!-- Campo: Lote -->
        <div class="mb-3">
          <label for="id_lote" class="form-label">Lote</label>
          {{ form.lote }}
        </div>

        <!-- Campo: Fechas múltiples -->
        <div class="mb-3">
          <label class="form-label">Fechas</label>
          <input type="text" id="multi-date-picker" class="form-control" placeholder="Selecciona fechas" />
          <ul id="selected-dates" class="mt-2 list-group"></ul>
          <input type="hidden" name="fechas_seleccionadas" id="fechas_seleccionadas" />
        </div>

        <!-- Campo: Cantidad -->
        <div class="mb-3">
          <label for="id_cantidad" class="form-label">Cantidad</label>
          {{ form.cantidad }}
        </div>

        <!-- Campo: Tarea -->
        <div class="mb-3">
          <label for="id_tarea" class="form-label">Tarea</label>
          {{ form.tarea }}
        </div>

        <!-- Campo: Observaciones -->
        <div class="mb-3">
          <label for="id_observaciones" class="form-label">Observaciones</label>
          {{ form.observaciones }}
        </div>

        <button type="submit" class="btn btn-success">Guardar</button>
        <a href="{% url 'listar_labores' %}" class="btn btn-secondary ms-2">Cancelar</a>
      </form>
    </div>
  </div>
</div>

<!-- === ESTILOS & LIBRERÍA DE CALENDARIO === -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- === SCRIPTS === -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const fincaField = document.getElementById('id_finca');
    const loteField = document.getElementById('id_lote');
    const trabajadorField = document.getElementById('id_trabajador');
    const cantidadField = document.getElementById('id_cantidad');

    // === Cargar lotes por finca ===
    function loadLotes(fincaId) {
      const urlBase = "{% url 'obtener_lotes_por_finca' 0 %}".replace('/0/', `/${fincaId}/`);
      fetch(urlBase)
        .then(response => response.json())
        .then(data => {
          loteField.innerHTML = '<option value="">---------</option>';
          data.forEach(lote => {
            const option = document.createElement('option');
            option.value = lote.id;
            option.textContent = lote.nombre;
            loteField.appendChild(option);
          });
        });
    }

    fincaField.addEventListener('change', () => {
      const fincaId = fincaField.value;

      if (fincaId) {
        // Trabajadores
        const url = "{% url 'cargar_trabajadores' %}?finca=" + fincaId;
        fetch(url)
          .then(response => response.json())
          .then(data => {
            trabajadorField.innerHTML = '<option value="">---------</option>';
            data.forEach(trabajador => {
              const option = document.createElement('option');
              option.value = trabajador.id;
              option.textContent = trabajador.nombre;
              trabajadorField.appendChild(option);
            });
          });

        // Lotes
        loadLotes(fincaId);
      } else {
        loteField.innerHTML = '<option value="">---------</option>';
        trabajadorField.innerHTML = '<option value="">---------</option>';
        cantidadField.readOnly = false;
        cantidadField.value = '';
      }
    });

    // === Rellenar cantidad desde tamaño de lote ===
    loteField.addEventListener('change', () => {
      const loteId = loteField.value;
      if (loteId) {
        const urlBase = "{% url 'obtener_tamano_lote' 0 %}".replace('/0/', `/${loteId}/`);
        fetch(urlBase)
          .then(response => response.json())
          .then(data => {
            cantidadField.value = data.tamano;
            cantidadField.readOnly = true;
          });
      } else {
        cantidadField.readOnly = false;
        cantidadField.value = '';
      }
    });

    if (loteField.value) {
      cantidadField.readOnly = true;
    }

// === Flatpickr multifecha ===
const selectedDatesList = document.getElementById('selected-dates');
const fechasInput = document.getElementById('fechas_seleccionadas');

const picker = flatpickr("#multi-date-picker", {
  mode: "multiple",
  dateFormat: "Y-m-d",
  onChange: function(selectedDates, dateStr, instance) {
    // Guardar string de fechas en el input oculto
    fechasInput.value = dateStr;

    // Limpiar lista para evitar duplicados
    selectedDatesList.innerHTML = '';
  }
});

  });
</script>
{% endblock %}

